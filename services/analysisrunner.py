from models.test import Test
from services.hypothesis_generation import HypothesisGenerator
from models.hypothesis import Hypothesis


class AnalysisRunner:
    def __init__(self, db, test_id):
        self.db = db
        self.test = Test.load(db, test_id)
        if not self.test:
            raise ValueError("Test not found with the given ID.")

    def next_hypothesis(self):
        if self.test.status == 'done':
            return "Analysis is already completed."

        for analyst_id in self.test.analyst_ids:
            if len(self.test.attempts.get(analyst_id, [])) < self.test.n_hypotheses_per_analyst:
                try:
                    hypothesis_text = HypothesisGenerator.generate_hypothesis(self.db, analyst_id, self.test.dataset_id)
                    hypothesis_id = Hypothesis.create(self.db, data='', hypothesis_text=hypothesis_text, analyst_id=analyst_id, dataset_id=self.test.dataset_id)
                    self.test.hypothesis_ids.append(hypothesis_id)
                    self.test.attempts[analyst_id].append('success')
                    self.test.update()
                    return f"New hypothesis generated by analyst {analyst_id}."
                except Exception as e:
                    self.test.attempts[analyst_id].append('failed')
                    self.test.update()
                    return f"Failed to generate hypothesis for analyst {analyst_id}: {str(e)}"

        self.test.status = 'done'
        self.test.update()
        return "No more hypotheses needed."

    def run(self):
        result = self.next_hypothesis()
        while result not in ["Analysis is already completed.", "No more hypotheses needed."]:
            result = self.next_hypothesis()
        return "All hypotheses generated or attempts exhausted."
